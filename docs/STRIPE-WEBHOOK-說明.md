# Stripe Webhook è½‰ç™¼ - èªªæ˜

## ğŸ¤” ä»€éº¼æ˜¯ Webhookï¼Ÿ

Webhook æ˜¯ Stripe ä¸»å‹•é€šçŸ¥ä½ çš„å¾Œç«¯ã€Œä»˜æ¬¾äº‹ä»¶ç™¼ç”Ÿäº†ã€çš„æ©Ÿåˆ¶ã€‚

### ç‚ºä»€éº¼éœ€è¦ Webhookï¼Ÿ

ç•¶ç”¨æˆ¶å®Œæˆä»˜æ¬¾å¾Œï¼ŒStripe éœ€è¦å‘Šè¨´ä½ çš„å¾Œç«¯ï¼š
- âœ… ä»˜æ¬¾æˆåŠŸäº†ï¼
- âœ… è¨‚é–±å·²å»ºç«‹ï¼
- âœ… è«‹æ›´æ–°ç”¨æˆ¶çš„æ–¹æ¡ˆï¼

ä½†å•é¡Œæ˜¯ï¼š**ä½ çš„æœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼ˆlocalhostï¼‰ç„¡æ³•ç›´æ¥æ¥æ”¶ Stripe çš„ Webhook**ï¼Œå› ç‚ºï¼š
- Stripe çš„ä¼ºæœå™¨åœ¨ç¶²éš›ç¶²è·¯ä¸Š
- ä½ çš„ `localhost:8000` åªæœ‰ä½ çš„é›»è…¦èƒ½è¨ªå•
- Stripe ç„¡æ³•ç›´æ¥é€£æ¥åˆ°ä½ çš„æœ¬åœ°é›»è…¦

## ğŸ”„ Stripe CLI çš„ä½œç”¨

`stripe listen` å‘½ä»¤å»ºç«‹äº†ä¸€å€‹ã€Œæ©‹æ¨‘ã€ï¼š

```
Stripe ä¼ºæœå™¨
    â†“
    â†“ (é€éç¶²éš›ç¶²è·¯)
    â†“
Stripe CLI (åœ¨ä½ çš„é›»è…¦ä¸Š)
    â†“
    â†“ (æœ¬åœ°è½‰ç™¼)
    â†“
ä½ çš„å¾Œç«¯ (localhost:8000)
```

### å…·é«”æµç¨‹

1. **ç”¨æˆ¶å®Œæˆä»˜æ¬¾** â†’ Stripe ä¼ºæœå™¨æ”¶åˆ°ä»˜æ¬¾
2. **Stripe ç™¼é€ Webhook** â†’ ç™¼é€åˆ° Stripe CLIï¼ˆä¸æ˜¯ç›´æ¥åˆ°ä½ çš„å¾Œç«¯ï¼‰
3. **Stripe CLI è½‰ç™¼** â†’ å°‡ Webhook è½‰ç™¼åˆ° `http://localhost:8000/api/stripe/webhook`
4. **ä½ çš„å¾Œç«¯è™•ç†** â†’ æ›´æ–°è³‡æ–™åº«ï¼Œå‡ç´šç”¨æˆ¶æ–¹æ¡ˆ

## ğŸ“ å¯¦éš›ä¾‹å­

### æ²’æœ‰ Webhook è½‰ç™¼æœƒæ€æ¨£ï¼Ÿ

```
ç”¨æˆ¶ä»˜æ¬¾ â†’ Stripe æ”¶åˆ°éŒ¢ âœ…
         â†’ ä½†ä½ çš„å¾Œç«¯ä¸çŸ¥é“ âŒ
         â†’ ç”¨æˆ¶æ–¹æ¡ˆæ²’æœ‰å‡ç´š âŒ
         â†’ ç”¨æˆ¶ä»˜äº†éŒ¢ä½†é‚„æ˜¯å…è²»æ–¹æ¡ˆ ğŸ˜±
```

### æœ‰ Webhook è½‰ç™¼æœƒæ€æ¨£ï¼Ÿ

```
ç”¨æˆ¶ä»˜æ¬¾ â†’ Stripe æ”¶åˆ°éŒ¢ âœ…
         â†’ Stripe ç™¼é€ Webhook âœ…
         â†’ Stripe CLI è½‰ç™¼åˆ°ä½ çš„å¾Œç«¯ âœ…
         â†’ å¾Œç«¯æ›´æ–°è³‡æ–™åº« âœ…
         â†’ ç”¨æˆ¶æ–¹æ¡ˆè‡ªå‹•å‡ç´š âœ…
         â†’ ä¸€åˆ‡æ­£å¸¸ï¼ğŸ‰
```

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### æœ¬åœ°é–‹ç™¼ï¼ˆå¿…é ˆï¼‰

```bash
# é€™å€‹å‘½ä»¤æœƒä¸€ç›´é‹è¡Œï¼Œä¸è¦é—œé–‰
stripe listen --forward-to http://localhost:8000/api/stripe/webhook
```

**è¼¸å‡ºç¯„ä¾‹ï¼š**
```
> Ready! Your webhook signing secret is whsec_xxxxx (^C to quit)
> --> checkout.session.completed [evt_123456]
> <-- [200] POST http://localhost:8000/api/stripe/webhook [evt_123456]
```

é€™è¡¨ç¤ºï¼š
- `-->` = Stripe ç™¼é€äº‹ä»¶çµ¦ä½ 
- `<--` = ä½ çš„å¾Œç«¯å›æ‡‰ï¼ˆ200 = æˆåŠŸï¼‰

### ç”Ÿç”¢ç’°å¢ƒï¼ˆä¸éœ€è¦ CLIï¼‰

ç”Ÿç”¢ç’°å¢ƒä¸éœ€è¦ `stripe listen`ï¼Œå› ç‚ºï¼š
- ä½ çš„å¾Œç«¯éƒ¨ç½²åœ¨å…¬é–‹çš„ç¶²è·¯ä¸Šï¼ˆä¾‹å¦‚ï¼š`https://api.yourdomain.com`ï¼‰
- Stripe å¯ä»¥ç›´æ¥ç™¼é€ Webhook åˆ°ä½ çš„å¾Œç«¯
- åœ¨ Stripe Dashboard è¨­å®š Webhook endpoint URL å³å¯

## âš ï¸ é‡è¦æé†’

1. **å¿…é ˆä¸€ç›´é‹è¡Œ**ï¼š`stripe listen` éœ€è¦ä¸€ç›´é‹è¡Œï¼Œé—œé–‰å¾Œå°±ç„¡æ³•æ¥æ”¶ Webhook
2. **éœ€è¦å¾Œç«¯é‹è¡Œ**ï¼šå¾Œç«¯å¿…é ˆå…ˆå•Ÿå‹•ï¼Œå¦å‰‡ Webhook è½‰ç™¼æœƒå¤±æ•—
3. **åªåœ¨é–‹ç™¼æ™‚éœ€è¦**ï¼šæœ¬åœ°é–‹ç™¼æ‰éœ€è¦ï¼Œç”Ÿç”¢ç’°å¢ƒä¸éœ€è¦

## ğŸ¯ ç¸½çµ

**ç°¡å–®ä¾†èªªï¼š**
- Webhook = Stripe å‘Šè¨´ä½ ã€Œä»˜æ¬¾å®Œæˆäº†ã€
- `stripe listen` = è®“ Stripe èƒ½é€£æ¥åˆ°ä½ çš„æœ¬åœ°å¾Œç«¯
- æ²’æœ‰å®ƒ = ä»˜æ¬¾æˆåŠŸä½†æ–¹æ¡ˆä¸æœƒè‡ªå‹•å‡ç´š

**æ‰€ä»¥é€™å€‹æ­¥é©Ÿæ˜¯å¿…é ˆçš„ï¼** âœ…
