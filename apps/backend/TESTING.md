# æ¸¬è©¦åŸ·è¡ŒæŒ‡å—

## ğŸ“‹ æ¸¬è©¦é¡å‹

### 1. å–®å…ƒæ¸¬è©¦ (Unit Tests)
- **ä½ç½®**: `src/**/*.spec.ts`
- **ç”¨é€”**: æ¸¬è©¦å–®ä¸€æœå‹™/å‡½æ•¸çš„é‚è¼¯
- **ç‰¹é»**: ä½¿ç”¨ Mockï¼Œä¸é€£æ¥çœŸå¯¦è³‡æ–™åº«

### 2. E2E æ¸¬è©¦ (End-to-End Tests)
- **ä½ç½®**: `test/**/*.e2e-spec.ts`
- **ç”¨é€”**: æ¸¬è©¦å®Œæ•´ API æµç¨‹
- **ç‰¹é»**: é€£æ¥çœŸå¯¦æ¸¬è©¦è³‡æ–™åº«

---

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

### åŸºæœ¬å‘½ä»¤

```bash
cd apps/backend
```

#### 1. åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦
```bash
npm test
# æˆ–
npm run test
```

#### 2. åŸ·è¡Œæ‰€æœ‰ E2E æ¸¬è©¦
```bash
npm run test:e2e
```

#### 3. åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ
```bash
# å–®å…ƒæ¸¬è©¦
npm test -- quota.service.spec.ts

# E2E æ¸¬è©¦
npm run test:e2e -- chatbots.e2e-spec.ts
```

#### 4. ç›£è½æ¨¡å¼ï¼ˆè‡ªå‹•é‡æ–°åŸ·è¡Œï¼‰
```bash
npm run test:watch
```

#### 5. åŸ·è¡Œæ¸¬è©¦ä¸¦æŸ¥çœ‹è¦†è“‹ç‡
```bash
# å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡
npm run test:cov

# E2E æ¸¬è©¦è¦†è“‹ç‡
npm run test:cov:e2e
```

#### 6. åŸ·è¡Œç‰¹å®šæ¸¬è©¦ä¸¦æŸ¥çœ‹è¦†è“‹ç‡
```bash
npm test -- quota.service.spec.ts --coverage
```

---

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š

### æŸ¥çœ‹è¦†è“‹ç‡å ±å‘Š
```bash
# åŸ·è¡Œæ¸¬è©¦å¾Œï¼Œè¦†è“‹ç‡å ±å‘Šæœƒç”Ÿæˆåœ¨ï¼š
coverage/lcov-report/index.html

# åœ¨ç€è¦½å™¨æ‰“é–‹
open coverage/lcov-report/index.html
```

### è¦†è“‹ç‡ç›®æ¨™
- **å–®å…ƒæ¸¬è©¦**: æ ¸å¿ƒæœå‹™ 90%+
- **E2E æ¸¬è©¦**: é—œéµ API 100%
- **æ•´é«”è¦†è“‹ç‡**: 80%+

---

## ğŸ” å¸¸ç”¨æ¸¬è©¦å ´æ™¯

### åŸ·è¡Œå–®å€‹æ¸¬è©¦æ¡ˆä¾‹
```bash
# ä½¿ç”¨ -t åƒæ•¸æŒ‡å®šæ¸¬è©¦åç¨±
npm test -- -t "æ‡‰è©²å…è¨±ç„¡é™åˆ¶æ–¹æ¡ˆ"
```

### åŸ·è¡Œç‰¹å®š describe å€å¡Š
```bash
npm test -- -t "QuotaService"
```

### åŸ·è¡Œå¤±æ•—çš„æ¸¬è©¦
```bash
npm test -- --onlyFailures
```

### è©³ç´°è¼¸å‡ºæ¨¡å¼
```bash
npm test -- --verbose
```

---

## ğŸ›  é™¤éŒ¯æ¸¬è©¦

### ä½¿ç”¨ Node.js Inspector
```bash
npm run test:debug
```

ç„¶å¾Œåœ¨ Chrome æ‰“é–‹ `chrome://inspect` é€²è¡Œé™¤éŒ¯ã€‚

### åŸ·è¡Œå–®å€‹æ¸¬è©¦æª”æ¡ˆä¸¦é™¤éŒ¯
```bash
node --inspect-brk node_modules/.bin/jest quota.service.spec.ts --runInBand
```

---

## ğŸ“ æ¸¬è©¦æª”æ¡ˆå‘½åè¦ç¯„

### å–®å…ƒæ¸¬è©¦
- **æª”æ¡ˆå**: `*.spec.ts`
- **ä½ç½®**: èˆ‡è¢«æ¸¬è©¦æª”æ¡ˆåŒç›®éŒ„
- **ç¯„ä¾‹**: `src/common/quota.service.spec.ts`

### E2E æ¸¬è©¦
- **æª”æ¡ˆå**: `*.e2e-spec.ts`
- **ä½ç½®**: `test/` ç›®éŒ„
- **ç¯„ä¾‹**: `test/chatbots.e2e-spec.ts`

---

## âš™ï¸ Jest é…ç½®

### å–®å…ƒæ¸¬è©¦é…ç½®
- **æª”æ¡ˆ**: `package.json` çš„ `jest` å€å¡Š
- **rootDir**: `src`
- **testRegex**: `.*\\.spec\\.ts$`

### E2E æ¸¬è©¦é…ç½®
- **æª”æ¡ˆ**: `test/jest-e2e.json`
- **rootDir**: `..`
- **testRegex**: `.e2e-spec.ts$`

---

## ğŸ¯ å¿«é€Ÿåƒè€ƒ

| å‘½ä»¤ | èªªæ˜ |
|------|------|
| `npm test` | åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦ |
| `npm run test:watch` | ç›£è½æ¨¡å¼ |
| `npm run test:cov` | å–®å…ƒæ¸¬è©¦ + è¦†è“‹ç‡ |
| `npm run test:e2e` | åŸ·è¡Œ E2E æ¸¬è©¦ |
| `npm test -- <æª”æ¡ˆå>` | åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ |
| `npm test -- -t "æ¸¬è©¦åç¨±"` | åŸ·è¡Œç‰¹å®šæ¸¬è©¦æ¡ˆä¾‹ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### é–‹ç™¼æ™‚çš„å·¥ä½œæµç¨‹

1. **ä¿®æ”¹å–®ä¸€ Service**
   ```bash
   # åªè·‘ç›¸é—œæ¸¬è©¦ï¼ˆå¿«é€Ÿï¼‰
   npm test -- quota.service.spec.ts
   
   # æˆ–ç›£è½æ¨¡å¼ï¼ˆè‡ªå‹•é‡æ–°åŸ·è¡Œï¼‰
   npm run test:watch -- quota.service.spec.ts
   ```

2. **ä¿®æ”¹ API ç«¯é»**
   ```bash
   # å…ˆè·‘å–®å…ƒæ¸¬è©¦ï¼ˆå¿«é€Ÿé©—è­‰é‚è¼¯ï¼‰
   npm test -- query.service.spec.ts
   
   # å†è·‘ E2E æ¸¬è©¦ï¼ˆå®Œæ•´ API æµç¨‹ï¼‰
   npm run test:e2e -- query.e2e-spec.ts
   ```

3. **æäº¤å‰**
   ```bash
   # è·‘æ‰€æœ‰å–®å…ƒæ¸¬è©¦ï¼ˆç´„ 1-2 ç§’ï¼‰
   npm test
   
   # å¦‚æœä¿®æ”¹äº† APIï¼Œè·‘ç›¸é—œçš„ E2E æ¸¬è©¦
   npm run test:e2e -- query.e2e-spec.ts
   ```

4. **é‡è¦è®Šæ›´ï¼ˆPRã€ç™¼å¸ƒå‰ï¼‰**
   ```bash
   # è·‘æ‰€æœ‰æ¸¬è©¦
   npm test
   npm run test:e2e
   ```

### æ¸¬è©¦ç­–ç•¥

- **é–‹ç™¼æ™‚**: åªè·‘ç›¸é—œæ¸¬è©¦ï¼Œå¿«é€Ÿåé¥‹
- **æäº¤å‰**: è·‘æ‰€æœ‰å–®å…ƒæ¸¬è©¦ï¼Œç¢ºä¿æ²’æœ‰ç ´å£ç¾æœ‰åŠŸèƒ½
- **CI/CD**: è·‘æ‰€æœ‰æ¸¬è©¦ + è¦†è“‹ç‡æª¢æŸ¥
- **é™¤éŒ¯**: ä½¿ç”¨ `npm run test:debug` é€²è¡Œé™¤éŒ¯

---

## ğŸ“š å¯¦éš›ä½¿ç”¨ç¯„ä¾‹

### å ´æ™¯ 1: ä¿®æ”¹ QuotaService
```bash
cd apps/backend
npm test -- quota.service.spec.ts
```

### å ´æ™¯ 2: ä¿®æ”¹ Query API
```bash
# å…ˆè·‘å–®å…ƒæ¸¬è©¦
npm test -- query.service.spec.ts

# å†è·‘ E2E æ¸¬è©¦
npm run test:e2e -- query.e2e-spec.ts
```

### å ´æ™¯ 3: é–‹ç™¼ä¸­æŒçºŒæ¸¬è©¦
```bash
# ç›£è½æ¨¡å¼ï¼Œè‡ªå‹•é‡æ–°åŸ·è¡Œ
npm run test:watch -- quota.service.spec.ts
```

### å ´æ™¯ 4: æŸ¥çœ‹è¦†è“‹ç‡
```bash
npm test -- quota.service.spec.ts --coverage
open coverage/lcov-report/index.html
```

### å ´æ™¯ 5: åŸ·è¡Œç‰¹å®šæ¸¬è©¦æ¡ˆä¾‹
```bash
npm test -- quota.service.spec.ts -t "æ‡‰è©²å…è¨±ç„¡é™åˆ¶æ–¹æ¡ˆ"
```

---

## ğŸ¯ å¸¸è¦‹å•é¡Œ

### Q: ä¿®æ”¹åŠŸèƒ½å¾Œéœ€è¦è·‘å…¨éƒ¨æ¸¬è©¦å—ï¼Ÿ
**A:** ä¸éœ€è¦ã€‚é–‹ç™¼æ™‚åªè·‘ç›¸é—œæ¸¬è©¦ï¼Œæäº¤å‰è·‘å…¨éƒ¨æ¸¬è©¦ã€‚

### Q: å¦‚ä½•çŸ¥é“è¦è·‘å“ªäº›æ¸¬è©¦ï¼Ÿ
**A:** 
- ä¿®æ”¹ Service â†’ è·‘å°æ‡‰çš„ `.spec.ts`
- ä¿®æ”¹ API â†’ è·‘å°æ‡‰çš„ `.e2e-spec.ts`
- ä¸ç¢ºå®š â†’ è·‘ `npm test`ï¼ˆæ‰€æœ‰å–®å…ƒæ¸¬è©¦ï¼‰

### Q: æ¸¬è©¦å¤±æ•—æ€éº¼è¾¦ï¼Ÿ
**A:** 
1. æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯
2. ç¢ºèªæ˜¯å¦ç‚ºé æœŸè¡Œç‚ºæ”¹è®Š
3. ä½¿ç”¨ `npm run test:debug` é™¤éŒ¯
4. æª¢æŸ¥æ¸¬è©¦è³‡æ–™æ˜¯å¦æ­£ç¢º

### Q: E2E æ¸¬è©¦å¾ˆæ…¢æ€éº¼è¾¦ï¼Ÿ
**A:** 
- E2E æ¸¬è©¦éœ€è¦çœŸå¯¦è³‡æ–™åº«ï¼Œç¢ºå¯¦è¼ƒæ…¢
- é–‹ç™¼æ™‚å„ªå…ˆä½¿ç”¨å–®å…ƒæ¸¬è©¦ï¼ˆå¿«é€Ÿï¼‰
- E2E æ¸¬è©¦åœ¨æäº¤å‰æˆ–é‡è¦è®Šæ›´æ™‚åŸ·è¡Œ

---

## ğŸ“ˆ æ¸¬è©¦æˆæœç¸½çµ

### âœ… å·²å®Œæˆæ¸¬è©¦çµ±è¨ˆ

#### å–®å…ƒæ¸¬è©¦ (Unit Tests) - 86 å€‹æ¸¬è©¦

| æœå‹™ | æ¸¬è©¦æª”æ¡ˆ | æ¸¬è©¦æ•¸é‡ | ç‹€æ…‹ |
|------|---------|---------|------|
| **QuotaService** | `src/common/quota.service.spec.ts` | 31 | âœ… å®Œæˆ |
| **SessionsService** | `src/sessions/sessions.service.spec.ts` | 28 | âœ… å®Œæˆ |
| **QueryService** | `src/query/query.service.spec.ts` | 17 | âœ… å®Œæˆ |
| **AuthService** | `src/auth/auth.service.spec.ts` | 10 | âœ… å®Œæˆ |

**å–®å…ƒæ¸¬è©¦ç¸½è¨ˆ**: 86 å€‹æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé âœ…

#### E2E æ¸¬è©¦ (End-to-End Tests) - 42 å€‹æ¸¬è©¦

| API æ¨¡çµ„ | æ¸¬è©¦æª”æ¡ˆ | æ¸¬è©¦æ•¸é‡ | ç‹€æ…‹ |
|---------|---------|---------|------|
| **Query API** | `test/query.e2e-spec.ts` | 15 | âœ… å®Œæˆ |
| **Auth API** | `test/auth.e2e-spec.ts` | 7 | âœ… å®Œæˆ |
| **Sessions API** | `test/sessions.e2e-spec.ts` | 20 | âœ… å®Œæˆ |

**E2E æ¸¬è©¦ç¸½è¨ˆ**: 42 å€‹æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé âœ…

### ğŸ“Š æ¸¬è©¦è¦†è“‹ç¯„åœ

#### æ ¸å¿ƒæœå‹™æ¸¬è©¦è¦†è“‹

1. **QuotaService** (é…é¡ç®¡ç†)
   - âœ… æœˆåº¦æŸ¥è©¢æ¬¡æ•¸çµ±è¨ˆ
   - âœ… æŸ¥è©¢é…é¡æª¢æŸ¥èˆ‡é©—è­‰
   - âœ… Chatbot å»ºç«‹é…é¡æª¢æŸ¥
   - âœ… FAQ å»ºç«‹é…é¡æª¢æŸ¥
   - âœ… é…é¡ä½¿ç”¨æƒ…æ³æŸ¥è©¢
   - âœ… é‚Šç•Œæ¢ä»¶è™•ç†ï¼ˆnullã€ç„¡é™åˆ¶æ–¹æ¡ˆï¼‰

2. **SessionsService** (Session ç®¡ç†)
   - âœ… Token ç”Ÿæˆèˆ‡é©—è­‰
   - âœ… Session å»ºç«‹ã€æŸ¥è©¢ã€æ›´æ–°ã€åˆªé™¤
   - âœ… Session éæœŸè™•ç†
   - âœ… æŸ¥è©¢æ¬¡æ•¸ç´¯è¨ˆ
   - âœ… Session åˆå§‹åŒ–ï¼ˆinitSessionï¼‰
   - âœ… æœ‰æ•ˆæœŸå»¶é•·

3. **QueryService** (æŸ¥è©¢è™•ç†)
   - âœ… ä¸Šä¸‹æ–‡å•ç­”ï¼ˆchatWithContextï¼‰
   - âœ… Embedding ç”Ÿæˆèˆ‡ fallback
   - âœ… Elasticsearch æœå°‹æ•´åˆ
   - âœ… LLM äº’å‹•
   - âœ… FAQ æ“ä½œè¨˜éŒ„ï¼ˆlogFaqActionï¼‰
   - âœ… FAQ ç€è¦½è¨˜éŒ„ï¼ˆlogFaqBrowseï¼‰
   - âœ… Preview æ¨¡å¼æ”¯æ´

4. **AuthService** (èªè­‰æœå‹™)
   - âœ… ç”¨æˆ¶ç²å–æˆ–å‰µå»ºï¼ˆgetOrCreateUserï¼‰
   - âœ… Supabase æ•´åˆ
   - âœ… Tenant è‡ªå‹•å‰µå»º
   - âœ… æ™ºèƒ½åˆä½µé‚è¼¯ï¼ˆemail åŒ¹é…ï¼‰
   - âœ… é è¨­å€¼è™•ç†

#### API ç«¯é»æ¸¬è©¦è¦†è“‹

1. **Query API** (`/query/*`)
   - âœ… `POST /query/chat` - å•ç­”æŸ¥è©¢ï¼ˆæœ‰/ç„¡ Sessionã€éæœŸè™•ç†ã€Preview æ¨¡å¼ï¼‰
   - âœ… `POST /query/log-faq-action` - Feedback è¨˜éŒ„ï¼ˆviewedã€likeã€dislikeï¼‰
   - âœ… `POST /query/log-faq-browse` - ç›´æ¥ç€è¦½è¨˜éŒ„

2. **Auth API** (`/auth/*`)
   - âœ… `POST /auth/get-or-create-user` - ç”¨æˆ¶ç²å–/å‰µå»ºï¼ˆæ–°ç”¨æˆ¶ã€ç¾æœ‰ç”¨æˆ¶ã€æ™ºèƒ½åˆä½µï¼‰

3. **Sessions API** (`/sessions/*`)
   - âœ… `POST /sessions/init` - åˆå§‹åŒ– Sessionï¼ˆå…¬é–‹ APIï¼‰
   - âœ… `POST /sessions` - å»ºç«‹ Session
   - âœ… `GET /sessions` - å–å¾—åˆ—è¡¨ï¼ˆéæ¿¾ã€åˆ†é ï¼‰
   - âœ… `GET /sessions/:id` - å–å¾—å–®ä¸€ Session
   - âœ… `GET /sessions/token/:token` - é€é token æŸ¥è©¢
   - âœ… `PATCH /sessions/:id` - æ›´æ–° Session
   - âœ… `POST /sessions/:id/extend` - å»¶é•·æœ‰æ•ˆæœŸ
   - âœ… `DELETE /sessions/:id` - åˆªé™¤ Session

### ğŸ¯ æ¸¬è©¦å“è³ªæŒ‡æ¨™

- **ç¸½æ¸¬è©¦æ•¸é‡**: 128 å€‹æ¸¬è©¦
- **é€šéç‡**: 100% âœ…
- **æ¸¬è©¦é¡å‹**: å–®å…ƒæ¸¬è©¦ + E2E æ¸¬è©¦
- **è¦†è“‹ç¯„åœ**: æ ¸å¿ƒæœå‹™ + é—œéµ API

### ğŸ“ æ¸¬è©¦æª”æ¡ˆæ¸…å–®

#### å–®å…ƒæ¸¬è©¦æª”æ¡ˆ
```
apps/backend/src/
â”œâ”€â”€ common/
â”‚   â””â”€â”€ quota.service.spec.ts          (31 å€‹æ¸¬è©¦)
â”œâ”€â”€ sessions/
â”‚   â””â”€â”€ sessions.service.spec.ts        (28 å€‹æ¸¬è©¦)
â”œâ”€â”€ query/
â”‚   â””â”€â”€ query.service.spec.ts          (17 å€‹æ¸¬è©¦)
â””â”€â”€ auth/
    â””â”€â”€ auth.service.spec.ts            (10 å€‹æ¸¬è©¦)
```

#### E2E æ¸¬è©¦æª”æ¡ˆ
```
apps/backend/test/
â”œâ”€â”€ query.e2e-spec.ts                   (15 å€‹æ¸¬è©¦)
â”œâ”€â”€ auth.e2e-spec.ts                    (7 å€‹æ¸¬è©¦)
â””â”€â”€ sessions.e2e-spec.ts                (20 å€‹æ¸¬è©¦)
```

### ğŸš€ ä¸‹ä¸€æ­¥å»ºè­°

#### å„ªå…ˆç´šé«˜
1. **Chatbots API E2E æ¸¬è©¦** - å·²æœ‰åŸºç¤æ¸¬è©¦ï¼Œå¯æ“´å……æ›´å¤šå ´æ™¯
2. **FAQs API E2E æ¸¬è©¦** - å·²æœ‰åŸºç¤æ¸¬è©¦ï¼Œå¯æ“´å……æ›´å¤šå ´æ™¯
3. **ElasticsearchService å–®å…ƒæ¸¬è©¦** - æœå°‹æ ¸å¿ƒåŠŸèƒ½
4. **LlmService å–®å…ƒæ¸¬è©¦** - AI è™•ç†æ ¸å¿ƒåŠŸèƒ½

#### å„ªå…ˆç´šä¸­
1. **Topics API E2E æ¸¬è©¦** - ä¸»é¡Œç®¡ç†
2. **Plans API E2E æ¸¬è©¦** - æ–¹æ¡ˆç®¡ç†
3. **Users API E2E æ¸¬è©¦** - ç”¨æˆ¶ç®¡ç†

#### å„ªå…ˆç´šä½
1. **æ•ˆèƒ½æ¸¬è©¦** - å¤§é‡è³‡æ–™è™•ç†
2. **ä½µç™¼æ¸¬è©¦** - åŒæ™‚è«‹æ±‚è™•ç†
3. **æ•´åˆæ¸¬è©¦** - è·¨æ¨¡çµ„äº’å‹•

### ğŸ“š æ¸¬è©¦æ–‡ä»¶

- **æ¸¬è©¦åŸ·è¡ŒæŒ‡å—**: `apps/backend/TESTING.md` (æœ¬æ–‡ä»¶)
- **æ¸¬è©¦é…ç½®**: `apps/backend/test/jest-e2e.json`
- **Jest é…ç½®**: `apps/backend/package.json` (jest å€å¡Š)

---

**æœ€å¾Œæ›´æ–°**: 2025-01-XX
**æ¸¬è©¦ç‹€æ…‹**: âœ… 128/128 é€šé
